{% extends "base.html" %}
{% block title %}Abastecimentos{% endblock %}
{% block page_title %}Abastecimentos{% endblock %}
{% block head_extra %}
  {{ super() }}
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .card-custom {
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
      margin-bottom: 2rem;
    }
    .form-label {
      font-weight: 500;
    }
    .btn-primary-custom {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      border-radius: 25px;
      padding: 0.75rem 2rem;
      color: white;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    .btn-primary-custom:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      color: white;
    }
    .table-responsive-custom {
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    }
    .table-custom thead {
      background-color: #667eea;
      color: white;
    }
    .table-custom tbody tr:hover {
      background-color: #f5f5f5;
    }
    .alert-custom {
      border-radius: 10px;
      margin-bottom: 1.5rem;
    }
    .filter-section {
      background-color: #f8f9fa;
      padding: 1rem;
      border-radius: 10px;
      margin-bottom: 1rem;
    }
  </style>
{% endblock %}
{% block content %}
<div class="container-fluid">

    <!-- Filtros -->
    <div class="card card-custom mb-4">
      <div class="card-header bg-white pt-4 pb-3">
        <h5 class="card-title mb-0"><i class="fas fa-filter me-2"></i>Filtros</h5>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-3">
            <label for="filtro_mes" class="form-label">Mês</label>
            <select class="form-select" id="filtro_mes">
              <option value="">Todos os meses</option>
              {% for mes in meses_disponiveis %}
                <option value="{{ mes }}">{{ mes }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-3">
            <label for="filtro_veiculo" class="form-label">Veículo</label>
            <select class="form-select" id="filtro_veiculo">
              <option value="">Todos os veículos</option>
              {% for vehicle in vehicles %}
                <option value="{{ vehicle.placa }}">{{ vehicle.placa }} ({{ vehicle.tipo }})</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-3">
            <label for="filtro_motorista" class="form-label">Motorista</label>
            <select class="form-select" id="filtro_motorista">
              <option value="">Todos os motoristas</option>
              {% for driver in drivers %}
                <option value="{{ driver.nome_completo }}">{{ driver.nome_completo }}</option>
              {% endfor %}
            </select>
          </div>
          {% if session['usuario_tipo'] == 'admin' and setores %}
          <div class="col-md-3">
            <label for="filtro_setor" class="form-label">Setor</label>
            <select class="form-select" id="filtro_setor" name="filtro_setor">
              <option value="">Todos os setores</option>
              {% for setor in setores %}
                <option value="{{ setor }}" {% if request.args.get('setor') == setor %}selected{% endif %}>{{ setor }}</option>
              {% endfor %}
            </select>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Botão Relatório de Abastecimentos -->
    <div class="d-flex justify-content-end mb-3">
      <button id="btn-relatorio-abastecimentos" class="btn btn-outline-secondary" type="button">
        <i class="fas fa-file-contract me-1"></i> Relatório de Abastecimentos
      </button>
    </div>

    <div class="card card-custom">
      <div class="card-header bg-white pt-4 pb-3 d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0"><i class="fas fa-list me-2"></i>Abastecimentos Registrados (<span id="total-registros">{{ items|length }}</span> registros)</h5>
        <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#modalRegistrarAbastecimento">
          <i class="fas fa-plus me-1"></i> Registrar Abastecimento
        </button>
      </div>
      <div class="card-body p-0">
        {% if items %}
          <div class="table-responsive table-responsive-custom">
            <table class="table table-striped table-hover mb-0 table-custom" id="tabela-abastecimentos">
              <thead>
                <tr>
                  <th>Data</th>
                  <th>Veículo</th>
                  <th>Motorista</th>
                  <th>Hodômetro</th>
                  <th>Litros</th>
                  <th>Valor</th>
                  <th>Nota</th>
                  <th>Ações</th>
                </tr>
              </thead>
              <tbody>
                {% for r in items %}
                <tr data-mes="{{ r.data.strftime('%Y-%m') }}" data-veiculo="{{ r.veiculo.placa if r.veiculo else 'N/A' }}" data-motorista="{{ r.motorista.nome_completo if r.motorista else 'N/A' }}" data-setor="{{ r.veiculo.tipo if r.veiculo else r.motorista.setor if r.motorista else '' }}">
                  <td>{{ r.data.strftime("%d/%m/%Y %H:%M") }}</td>
                  <td><strong>{{ r.veiculo.placa if r.veiculo else 'N/A' }}</strong></td>
                  <td>{{ r.motorista.nome_completo if r.motorista else 'N/A' }}</td>
                  <td>{{ "{:,.0f}".format(r.hodometro).replace(",", ".") }}</td>
                  <td>{{ "{:,.2f}".format(r.litros).replace(",", "X").replace(".", ",").replace("X", ".") }} L</td>
                  <td>R$ {{ "{:,.2f}".format(r.valor_total).replace(",", "X").replace(".", ",").replace("X", ".") }}</td>
                  <td>{{ r.numero_nota }}</td>
                  <td>
                    <a href="{{ url_for('editar_abastecimento', abastecimento_id=r.id) }}" class="btn btn-sm btn-outline-primary me-1" title="Editar">
                      <i class="fas fa-edit"></i>
                    </a>
                    <form method="post" action="{{ url_for('excluir_abastecimento', abastecimento_id=r.id) }}" class="d-inline" onsubmit="return confirm('Tem certeza que deseja excluir este abastecimento?');">
                      <button type="submit" class="btn btn-sm btn-outline-danger" title="Excluir">
                        <i class="fas fa-trash-alt"></i>
                      </button>
                    </form>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="alert alert-info m-4">Nenhum abastecimento encontrado.</div>
        {% endif %}
      </div>
    </div>

    <!-- Modal para registrar abastecimento -->
    <div class="modal fade" id="modalRegistrarAbastecimento" tabindex="-1" aria-labelledby="modalRegistrarAbastecimentoLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalRegistrarAbastecimentoLabel"><i class="fas fa-gas-pump me-2"></i>Registro de Abastecimento</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
          </div>
          <form method="post" novalidate>
            <div class="modal-body">
              {% if vehicles|length == 0 %}
                <div class="alert alert-warning alert-custom" role="alert">
                  <i class="fas fa-exclamation-triangle me-2"></i>Nenhum veículo cadastrado. Por favor, cadastre um veículo antes de registrar um abastecimento.
                </div>
              {% endif %}
              {% if drivers|length == 0 %}
                <div class="alert alert-warning alert-custom" role="alert">
                  <i class="fas fa-exclamation-triangle me-2"></i>Nenhum motorista cadastrado. Por favor, cadastre um motorista antes de registrar um abastecimento.
                </div>
              {% endif %}
              <div class="row g-3 mb-3">
                {% if setores %}
                <div class="col-md-3">
                  <label for="setor" class="form-label">Setor/Departamento</label>
                  <select class="form-select" id="setor" name="setor">
                    <option value="">Todos os setores</option>
                    {% for setor in setores %}
                      <option value="{{ setor }}">{{ setor }}</option>
                    {% endfor %}
                  </select>
                </div>
                {% endif %}
                <div class="col-md-3">
                  <label for="date" class="form-label">Data e Hora</label>
                  <input type="datetime-local" class="form-control" id="date" name="date" required>
                </div>
              </div>
              <div class="row g-3 mb-3">
                <div class="col-md-4">
                  <label for="vehicle_id" class="form-label">Veículo</label>
                  <select class="form-select" id="vehicle_id" name="vehicle_id" required {% if vehicles|length == 0 %}disabled{% endif %}>
                    <option value="">Selecione um veículo</option>
                    {% for vehicle in vehicles %}
                      <option value="{{ vehicle.id }}" data-combustivel="{{ vehicle.combustivel }}">{{ vehicle.placa }} ({{ vehicle.tipo }})</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-4">
                  <label for="combustivel_display" class="form-label">Combustível</label>
                  <input type="text" class="form-control" id="combustivel_display" disabled placeholder="Selecionar veículo...">
                  <input type="hidden" id="combustivel" name="combustivel">
                </div>
                <div class="col-md-4">
                  <label for="driver_id" class="form-label">Motorista</label>
                  <select class="form-select" id="driver_id" name="driver_id" required {% if drivers|length == 0 %}disabled{% endif %}>
                    <option value="">Selecione um motorista</option>
                    {% for driver in drivers %}
                      <option value="{{ driver.id }}">{{ driver.nome_completo }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
              <div class="row g-3 mb-3">
                <div class="col-md-3">
                  <label for="odometer" class="form-label">Hodômetro / Horímetro</label>
                  <input type="number" class="form-control" id="odometer" name="odometer" placeholder="Ex: 12345" required>
                </div>
                <div class="col-md-3">
                  <label for="liters" class="form-label">Litros Abastecidos</label>
                  <input type="number" class="form-control" id="liters" name="liters" step="0.01" placeholder="Ex: 45.50" required>
                </div>
                <div class="col-md-3">
                  <label for="total_value" class="form-label">Valor Total (R$)</label>
                  <input type="number" class="form-control" id="total_value" name="total_value" step="0.01" placeholder="Ex: 895.42" required>
                </div>
                <div class="col-md-3">
                  <label for="invoice_number" class="form-label">Número da Nota Fiscal</label>
                  <input type="text" class="form-control" id="invoice_number" name="invoice_number" placeholder="Ex: 123456" required>
                </div>
              </div>
              <div class="row g-3 mb-4">
                <div class="col-12">
                  <label for="observations" class="form-label">Observações (opcional)</label>
                  <textarea class="form-control" id="observations" name="observations" rows="3" placeholder="Detalhes do abastecimento..."></textarea>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button type="submit" class="btn btn-primary-custom">
                <i class="fas fa-save me-2"></i>Registrar Abastecimento
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
{% endblock %}
{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  // Attach vehicle select listener when modal is shown
  const modal = document.getElementById('modalRegistrarAbastecimento');
  modal.addEventListener('shown.bs.modal', function () {
    const vehicleSelect = document.getElementById("vehicle_id");
    const combustivelInput = document.getElementById("combustivel");
    const combustivelDisplay = document.getElementById("combustivel_display");
    vehicleSelect.addEventListener("change", function () {
      const selectedOption = vehicleSelect.options[vehicleSelect.selectedIndex];
      const combustivel = selectedOption.getAttribute("data-combustivel") || "";
      combustivelDisplay.value = combustivel;
      combustivelInput.value = combustivel;
    });
  });

  // Filtros
  const filtroMes = document.getElementById("filtro_mes");
  const filtroVeiculo = document.getElementById("filtro_veiculo");
  const filtroMotorista = document.getElementById("filtro_motorista");
  const filtroSetor = document.getElementById("filtro_setor");
  const tabela = document.getElementById("tabela-abastecimentos");
  const totalRegistros = document.getElementById("total-registros");

  // Extrair meses únicos dos dados
  const meses = new Set();
  document.querySelectorAll("#tabela-abastecimentos tbody tr").forEach(row => {
    meses.add(row.getAttribute("data-mes"));
  });

  // Ordenar meses (do mais recente para o mais antigo)
  const mesesOrdenados = Array.from(meses).sort().reverse();

  // Preencher dropdown de meses
  mesesOrdenados.forEach(mes => {
    const data = new Date(mes + "-01");
    const nomeMes = data.toLocaleString('pt-BR', { month: 'long', year: 'numeric' });
    const option = document.createElement("option");
    option.value = mes;
    option.textContent = nomeMes.charAt(0).toUpperCase() + nomeMes.slice(1);
    filtroMes.appendChild(option);
  });

  // Função para aplicar filtros
  function aplicarFiltros() {
    const mesSelecionado = filtroMes.value;
    const veiculoSelecionado = filtroVeiculo.value;
    const motoristaSelecionado = filtroMotorista.value;
    const setorSelecionado = filtroSetor ? filtroSetor.value : "";

    let registrosVisiveis = 0;

    document.querySelectorAll("#tabela-abastecimentos tbody tr").forEach(row => {
      const mes = row.getAttribute("data-mes");
      const veiculo = row.getAttribute("data-veiculo");
      const motorista = row.getAttribute("data-motorista");
      const setor = row.getAttribute("data-setor");

      const mostraMes = !mesSelecionado || mes === mesSelecionado;
      const mostraVeiculo = !veiculoSelecionado || veiculo === veiculoSelecionado;
      const mostraMotorista = !motoristaSelecionado || motorista === motoristaSelecionado;
      const mostraSetor = !setorSelecionado || setor === setorSelecionado;

      if (mostraMes && mostraVeiculo && mostraMotorista && mostraSetor) {
        row.style.display = "";
        registrosVisiveis++;
      } else {
        row.style.display = "none";
      }
    });
    totalRegistros.textContent = registrosVisiveis;
  }

  filtroMes.addEventListener("change", aplicarFiltros);
  filtroVeiculo.addEventListener("change", aplicarFiltros);
  filtroMotorista.addEventListener("change", aplicarFiltros);
  if (filtroSetor) filtroSetor.addEventListener("change", aplicarFiltros);

  aplicarFiltros();

  // Botão Relatório de Abastecimentos
  document.getElementById("btn-relatorio-abastecimentos").addEventListener("click", function() {
    // Montar query string com filtros, usando os parâmetros esperados pela view Flask
    const params = new URLSearchParams();
    // Mapeamento dos filtros da tela para os parâmetros do relatório
    if (filtroMes.value) {
      // filtroMes.value está no formato 'YYYY-MM', converter para data_inicio e data_fim
      const [ano, mes] = filtroMes.value.split('-');
      const dataInicio = `${ano}-${mes}-01`;
      // Último dia do mês
      const ultimoDia = new Date(ano, mes, 0).getDate();
      const dataFim = `${ano}-${mes}-${ultimoDia}`;
      params.append('data_inicio', dataInicio);
      params.append('data_fim', dataFim);
    }
    if (filtroVeiculo.value) {
      // Encontrar o ID do veículo pelo valor da placa
      const option = Array.from(document.getElementById('vehicle_id').options).find(opt => opt.text.includes(filtroVeiculo.value));
      if (option && option.value) {
        params.append('veiculo_id', option.value);
      }
    }
    if (filtroMotorista.value) {
      // Encontrar o ID do motorista pelo nome
      const option = Array.from(document.getElementById('driver_id').options).find(opt => opt.text === filtroMotorista.value);
      if (option && option.value) {
        params.append('motorista_id', option.value);
      }
    }
    // Garante que a URL base é exatamente a do endpoint Flask
    let url = "{{ url_for('relatorio_abastecimentos') }}";
    if (params.toString()) url += '?' + params.toString();
    // Redireciona na mesma aba para garantir contexto admin
    window.location.href = url;
  });
});
</script>
{% endblock %}