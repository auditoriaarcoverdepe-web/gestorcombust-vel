{% extends "base.html" %}

{% block title %}Veículos - Controle de Abastecimentos{% endblock %}
{% block page_title %}Veículos{% endblock %}

{% block head_extra %}
  {{ super() }}
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome para ícones -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* Estilos customizados para consistência com dashboard.html */
    .card-custom {
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
      margin-bottom: 2rem;
    }
    .form-label {
      font-weight: 500;
    }
    .btn-primary-custom {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      border-radius: 25px;
      padding: 0.75rem 2rem;
      color: white;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    .btn-primary-custom:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      color: white;
    }
    .table-responsive-custom {
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    }
    .table-custom thead {
      background-color: #667eea;
      color: white;
    }
    .table-custom tbody tr:hover {
      background-color: #f5f5f5;
    }
    /* Estilos para validação de formulário */
    .was-validated .form-control:invalid,
    .form-control.is-invalid {
      border-color: #dc3545;
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath d='m5.8 3.6.4.4.4-.4'/%3e%3cpath d='M6 7v1'/%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right calc(0.375em + 0.1875rem) center;
      background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
    }
    .was-validated .form-control:valid,
    .form-control.is-valid {
      border-color: #198754;
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23198754' d='M2.3 6.73.6 4.53c-.4-1.04.46-1.4 1.1-.8l1.1 1.4 3.4-3.8c.6-.63 1.6-.27 1.2.7l-4 4.6c-.43.5-.8.4-1.1.1z'/%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right calc(0.375em + 0.1875rem) center;
      background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
    }
    .invalid-feedback {
      display: none;
      width: 100%;
      margin-top: 0.25rem;
      font-size: 0.875em;
      color: #dc3545;
    }
    .was-validated .form-control:invalid ~ .invalid-feedback,
    .form-control.is-invalid ~ .invalid-feedback {
      display: block;
    }
    /* Melhorias para mobile */
    @media (max-width: 768px) {
      .btn-action-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }
      .btn-action-group .btn {
        width: 100%;
      }
    }
  </style>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <!-- Mensagens de feedback -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          <i class="fas fa-{{ 'check-circle' if category == 'success' else 'exclamation-triangle' }} me-2"></i>
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}



  <div class="card card-custom">
    <div class="card-header bg-white pt-4 pb-3 d-flex justify-content-between align-items-center">
      <h2 class="card-title h5 mb-0"><i class="fas fa-car me-2" aria-hidden="true"></i>Veículos Cadastrados ({{ items|length }} registros)</h2>
      <div>
        {% if session['usuario_tipo'] == 'admin' and setores %}
        <form method="get" class="d-inline me-3">
          <label for="setor" class="form-label me-2 mb-0">Filtrar por setor:</label>
          <select name="setor" id="setor" class="form-select form-select-sm d-inline" onchange="this.form.submit()">
            <option value="">Todos os setores</option>
            {% for setor in setores %}
              <option value="{{ setor }}" {% if request.args.get('setor') == setor %}selected{% endif %}>{{ setor }}</option>
            {% endfor %}
          </select>
          {% for key, value in request.args.items() %}
            {% if key != 'setor' %}
              <input type="hidden" name="{{ key }}" value="{{ value }}">
            {% endif %}
          {% endfor %}
        </form>
        {% endif %}
        <button class="btn btn-sm btn-primary me-2" data-bs-toggle="modal" data-bs-target="#modalAdicionarVeiculo">
          <i class="fas fa-plus me-1"></i> Adicionar Veículo
        </button>
        {% if items %}
        <span class="badge bg-primary rounded-pill me-2">{{ items|length }}</span>
        {% endif %}
        <a href="{{ url_for('visualizar_veiculos') }}" class="btn btn-sm btn-success">
          <i class="fas fa-file-pdf me-1"></i> Exportar/Imprimir
        </a>
      </div>
    </div>
    <div class="card-body p-0">
      {% if items %}
        <div class="table-responsive table-responsive-custom">
          <table class="table table-striped table-hover mb-0 table-custom" id="tabela-veiculos">
            <thead>
              <tr>
                <th scope="col">Placa</th>
                <th scope="col">Tipo</th>
                <th scope="col">Combustível</th>
                <th scope="col" class="text-end">Tanque (L)</th> <!-- Alterado para text-end -->
                <th scope="col" class="text-center">Ações</th>
              </tr>
            </thead>
            <tbody>
              {% for item in items %}
              <tr>
                <td><strong>{{ item.placa }}</strong></td>
                <td>{{ item.tipo }}</td>
                <td>{{ item.combustivel }}</td>
                <td class="text-end"> <!-- Alterado para text-end -->
                  {% if item.capacidade_tanque %}
                    {{ "%.2f"|format(item.capacidade_tanque)|replace(".", ",") }}
                  {% else %}
                    —
                  {% endif %}
                </td>
                <td>
                  <div class="btn-action-group d-flex justify-content-center">
                    <a href="{{ url_for("editar_veiculo", veiculo_id=item.id) }}" class="btn btn-sm btn-outline-primary me-1" title="Editar veículo" aria-label="Editar veículo {{ item.placa }}">
                      <i class="fas fa-edit" aria-hidden="true"></i>
                    </a>
                    <form method="post" action="{{ url_for("excluir_veiculo", veiculo_id=item.id) }}" class="d-inline">
                      <button type="submit" class="btn btn-sm btn-outline-danger" title="Excluir veículo" aria-label="Excluir veículo {{ item.placa }}" onclick="return confirm('Tem certeza que deseja excluir o veículo {{ item.placa }}?');">
                        <i class="fas fa-trash-alt" aria-hidden="true"></i>
                      </button>
                    </form>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="text-center py-5">
          <i class="fas fa-inbox fa-3x text-muted mb-3" aria-hidden="true"></i>
          <h3 class="h5 text-muted">Nenhum veículo cadastrado.</h3>
          <p class="text-muted">Comece adicionando um novo veículo usando o formulário acima.</p>
        </div>
      {% endif %}
    </div>
  </div>

<!-- Modal para adicionar veículo -->
<div class="modal fade" id="modalAdicionarVeiculo" tabindex="-1" aria-labelledby="modalAdicionarVeiculoLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalAdicionarVeiculoLabel"><i class="fas fa-car-side me-2"></i>Cadastro de Veículo</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <form method="post" novalidate>
        <div class="modal-body">
          <!-- Primeira linha: Placa e Tipo de Veículo -->
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="plate" class="form-label">Placa <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="plate" name="plate" placeholder="ABC-1234" 
                    pattern="[A-Z]{3}-?\d{4}|[A-Z]{3}\d[A-Z]\d{2}" 
                    title="Formato esperado: ABC-1234 ou ABC1D23" required>
              <div class="invalid-feedback">
                Por favor, insira uma placa válida (formato: ABC-1234 ou ABC1D23).
              </div>
            </div>
            <div class="col-md-6 mb-3">
              <label for="type" class="form-label">Tipo de Veículo <span class="text-danger">*</span></label>
              <select class="form-select" id="type" name="type" required>
                <option value="">Selecione</option>
                <option value="Leve">Leve</option>
                <option value="Pesado">Pesado</option>
                <option value="Máquina">Máquina</option>
              </select>
              <div class="invalid-feedback">
                Por favor, selecione um tipo de veículo.
              </div>
            </div>
          </div>
          
          <!-- Segunda linha: Combustível, Capacidade do Tanque e Setor (admin) -->
          <div class="row">
            <div class="col-md-4 mb-3">
              <label for="fuel_type" class="form-label">Combustível <span class="text-danger">*</span></label>
              <select class="form-select" id="fuel_type" name="fuel_type" required>
                <option value="">Selecione o tipo</option>
                {% for tipo in tipos_combustivel %}
                <option value="{{ tipo }}">{{ tipo }}</option>
                {% endfor %}
              </select>
              <div class="invalid-feedback">
                Por favor, selecione um tipo de combustível.
              </div>
            </div>
            <div class="col-md-4 mb-4">
              <label for="tank_capacity" class="form-label">Capacidade do Tanque (L)</label>
              <input type="number" class="form-control" id="tank_capacity" name="tank_capacity" 
                    step="0.1" min="0" placeholder="Ex: 50,00">
              <div class="invalid-feedback">
                Por favor, insira um valor válido para a capacidade do tanque.
              </div>
            </div>
            {% if session['usuario_tipo'] == 'admin' %}
            <div class="col-md-4 mb-4">
              <label for="setor" class="form-label">Setor/Secretaria <span class="text-danger">*</span></label>
              <select class="form-select" id="setor" name="setor" required>
                <option value="">Selecione o setor</option>
                {% for setor in setores %}
                  <option value="{{ setor }}">{{ setor }}</option>
                {% endfor %}
              </select>
              <div class="invalid-feedback">
                Por favor, selecione o setor/departamento.
              </div>
            </div>
            {% endif %}
          </div>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary-custom">
            <i class="fas fa-save me-2" aria-hidden="true"></i>Salvar Veículo
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <!-- Bootstrap JS Bundle with Popper -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    // Validação de formulário
    document.addEventListener('DOMContentLoaded', function() {
      // Selecionar todos os formulários que precisam de validação
      const forms = document.querySelectorAll('form[novalidate]');
      
      // Aplicar validação personalizada do Bootstrap
      Array.from(forms).forEach(form => {
        form.addEventListener('submit', event => {
          if (!form.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
          }
          
          form.classList.add('was-validated');
        }, false);
      });
    });
  </script>
{% endblock %}
