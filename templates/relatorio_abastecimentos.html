{% extends "base.html" %}

{% block title %}Relatório de Abastecimentos{% endblock %}
{% block page_title %}Relatório Abastecimento{% endblock %}

{% block head_extra %}
{{ super() }}
<style>
.relatorio-container {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    overflow: hidden;
    margin-bottom: 30px;
}
.relatorio-header {
    background: #f8f9fa;
    padding: 20px;
    border-bottom: 1px solid #e9ecef;
}
.relatorio-titulo {
    color: #1f2937;
    margin: 0;
}
.relatorio-subtitulo {
    color: #6b7280;
    margin: 5px 0 0 0;
}
.relatorio-info {
    font-size: 0.875rem;
    color: #4b5563;
    margin: 2px 0;
}
.relatorio-actions {
    padding: 15px 20px;
    background: #f8f9fa;
    border-top: 1px solid #e9ecef;
    display: flex;
    gap: 10px;
}
.btn-export-pdf {
    background-color: #007bff;
    color: white;
    padding: 8px 16px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.9rem;
    display: inline-flex;
    align-items: center;
    gap: 6px;
}
.btn-export-pdf:hover {
    background-color: #0056b3;
}
.filter-badges {
    margin-top: 10px;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}
.badge-filter {
    background: #e3f2fd;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 0.85rem;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    border: 1px solid #bbdefb;
}
.badge-filter .remove {
    color: #dc3545;
    cursor: pointer;
    font-weight: bold;
}
.table {
    margin-bottom: 0;
}
.table thead th {
    background-color: #0b5ed7;
    color: white;
    font-weight: 600;
}
.table tbody tr:nth-child(even) {
    background-color: #f8f9fa;
}
.total-row {
    font-weight: bold;
    background-color: #f0f3f8 !important;
}
/* Estilos para impressão */
@media print {
    .sidebar, .card, .relatorio-actions, .breadcrumb, nav[aria-label="breadcrumb"] {
        display: none !important;
    }
    body {
        margin: 0;
        padding: 20px;
    }
    .content {
        margin-left: 0;
        padding: 0;
    }
    .normal-content {
        display: none !important;
    }
    .print-only {
        display: block !important;
    }
    .relatorio-container {
        box-shadow: none;
        border: 1px solid #000;
    }
    .relatorio-header {
        border-bottom: 2px solid #0b5ed7;
        margin-bottom: 20px;
        padding-bottom: 15px;
    }
    .relatorio-titulo {
        color: #0b5ed7;
        font-size: 24px;
        margin: 10px 0;
        font-weight: 600;
    }
    .relatorio-subtitulo {
        color: #6c757d;
        font-size: 16px;
        margin: 5px 0;
    }
    .table {
        font-size: 10pt;
        border: 1px solid #000;
    }
    .table thead th {
        background-color: #000;
        color: white;
        border: 1px solid #000;
    }
    .table tbody td {
        border: 1px solid #000;
    }
    .total-row {
        background-color: #f0f0f0 !important;
        border: 1px solid #000;
    }
    .footer {
        margin-top: 20px;
        text-align: center;
        font-size: 10pt;
        color: #666;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="normal-content">
<div class="container-fluid">
    <!-- Filtros -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <i class="fas fa-filter"></i> Filtros
        </div>
        <div class="card-body">
            <form method="get" class="row g-3">
                {% if session['usuario_tipo'] == 'admin' %}
                <div class="col-md-3">
                    <label for="setor" class="form-label">Setor</label>
                    <select class="form-select" id="setor" name="setor">
                        <option value="">Todos os setores</option>
                        {% for setor in setores %}
                        <option value="{{ setor }}" {% if request.args.get('setor') == setor %}selected{% endif %}>{{ setor }}</option>
                        {% endfor %}
                    </select>
                </div>
                {% endif %}
                <div class="col-md-3">
                    <label for="data_inicio" class="form-label">Data Início</label>
                    <input type="date" class="form-control" id="data_inicio" name="data_inicio" value="{{ request.args.get('data_inicio', '') }}">
                </div>
                <div class="col-md-3">
                    <label for="data_fim" class="form-label">Data Fim</label>
                    <input type="date" class="form-control" id="data_fim" name="data_fim" value="{{ request.args.get('data_fim', '') }}">
                </div>
                <div class="col-md-3">
                    <label for="veiculo_id" class="form-label">Veículo</label>
                    <select class="form-select" id="veiculo_id" name="veiculo_id">
                        <option value="">Todos os veículos</option>
                        {% for veiculo in veiculos %}
                        <option value="{{ veiculo.id }}" {% if request.args.get('veiculo_id') == veiculo.id|string %}selected{% endif %}>
                            {{ veiculo.placa }} ({{ veiculo.tipo }})
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="motorista_id" class="form-label">Motorista</label>
                    <select class="form-select" id="motorista_id" name="motorista_id">
                        <option value="">Todos os motoristas</option>
                        {% for motorista in motoristas %}
                        <option value="{{ motorista.id }}" {% if request.args.get('motorista_id') == motorista.id|string %}selected{% endif %}>
                            {{ motorista.nome_completo }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="combustivel" class="form-label">Combustível</label>
                    <select class="form-select" id="combustivel" name="combustivel">
                        <option value="">Todos os tipos</option>
                        {% for tipo in tipos_combustivel %}
                        <option value="{{ tipo }}" {% if request.args.get('combustivel') == tipo %}selected{% endif %}>
                            {{ tipo }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="min_litros" class="form-label">Mín. Litros</label>
                    <input type="number" step="0.01" class="form-control" id="min_litros" name="min_litros" value="{{ request.args.get('min_litros', '') }}">
                </div>
                <div class="col-md-3">
                    <label for="max_litros" class="form-label">Máx. Litros</label>
                    <input type="number" step="0.01" class="form-control" id="max_litros" name="max_litros" value="{{ request.args.get('max_litros', '') }}">
                </div>
                
                <!-- Badges de filtros aplicados -->
                {% if filtros_aplicados %}
                <div class="col-12">
                    <div class="filter-badges">
                        {% for chave, valor in filtros_aplicados.items() %}
                        <div class="badge-filter">
                            {{ chave }}: {{ valor }}
                            <span class="remove" onclick="removeFilter('{{ chave }}')">×</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                <div class="col-md-12">
                    <div class="relatorio-actions d-flex gap-2 flex-wrap">
                        <button type="submit" class="btn btn-primary me-2">
                            <i class="fas fa-search me-1"></i>Filtrar
                        </button>
                        <a href="{{ url_for('relatorio_abastecimentos') }}" class="btn btn-outline-danger me-2">
                            <i class="fas fa-times me-1"></i>Limpar Filtros
                        </a>
                        <a href="{{ url_for('export_csv_relatorio_abastecimentos') }}" class="btn btn-outline-secondary me-2">
                            <i class="fas fa-file-csv me-1"></i>Exportar CSV
                        </a>
                        <a href="{{ url_for('export_pdf_relatorio_abastecimentos') }}" class="btn btn-outline-secondary me-2">
                            <i class="fas fa-file-pdf me-1"></i>Exportar PDF
                        </a>
                        <button onclick="window.print()" class="btn btn-outline-secondary me-2">
                            <i class="fas fa-print me-1"></i>Imprimir Relatório
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Informações do relatório -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="relatorio-info">
                <strong>Total de registros:</strong> {{ total_registros }}
                {% if filtros_aplicados %}
                <br><strong>Filtros aplicados:</strong>
                {% for chave, valor in filtros_aplicados.items() %}
                {{ chave }}: {{ valor }}{% if not loop.last %}, {% endif %}
                {% endfor %}
                {% endif %}
                <br><strong>Data de geração:</strong> {{ agora.strftime('%d/%m/%Y %H:%M') }}
            </div>
        </div>
    </div>

    <!-- Tabela de Dados -->
    <div class="table-responsive">
        <table class="table table-striped mb-0">
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Veículo</th>
                    <th>Motorista</th>
                    <th>Combustível</th>
                    <th>Nº Nota</th>
                    <th>Hodômetro</th>
                    <th class="text-right">Litros</th>
                    <th class="text-right">Valor Total</th>
                </tr>
            </thead>
            <tbody>
                {% if dados %}
                {% set total_litros = namespace(value=0) %}
                {% set total_valor = namespace(value=0) %}
                {% for abastecimento in dados %}
                {% set total_litros.value = total_litros.value + abastecimento.litros %}
                {% set total_valor.value = total_valor.value + abastecimento.valor_total %}
                <tr>
                    <td>{{ abastecimento.data.strftime('%d/%m/%Y') }}</td>
                    <td>{{ abastecimento.veiculo.placa if abastecimento.veiculo else 'N/A' }}</td>
                    <td>{{ abastecimento.motorista.nome_completo if abastecimento.motorista else 'N/A' }}</td>
                    <td>{{ abastecimento.veiculo.combustivel if abastecimento.veiculo else 'N/A' }}</td>
                    <td>{{ abastecimento.numero_nota }}</td>
                    <td>{{ abastecimento.hodometro|number(0) }} km</td>
                    <td class="text-right">{{ abastecimento.litros|litros }}</td>
                    <td class="text-right">{{ abastecimento.valor_total|currency }}</td>
                </tr>
                {% endfor %}
                <tr class="total-row">
                    <td colspan="6" class="text-right">Total:</td>
                    <td class="text-right">{{ total_litros.value|litros }}</td>
                    <td class="text-right">{{ total_valor.value|currency }}</td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="8" class="text-center text-muted py-3">
                        Nenhum abastecimento encontrado com os filtros aplicados.
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<div class="print-only" style="display: none;">
    <!-- Conteúdo para impressão -->
    <div class="relatorio-container">
        <div class="relatorio-header">
            <h2 class="relatorio-titulo">Relatório de Abastecimentos</h2>
            <p class="relatorio-subtitulo">Detalhamento de abastecimentos</p>

            <!-- Informações de Geração -->
            <div class="relatorio-info">
                <strong>Data de Geração:</strong> {{ agora.strftime('%d/%m/%Y %H:%M') }}
                <br><strong>Total de registros:</strong> {{ total_registros }}
                {% if filtros_aplicados %}
                <br><strong>Filtros aplicados:</strong>
                {% for chave, valor in filtros_aplicados.items() %}
                {{ chave }}: {{ valor }}{% if not loop.last %}, {% endif %}
                {% endfor %}
                {% endif %}
            </div>
        </div>

        <!-- Tabela de Dados -->
        <div class="table-responsive">
            <table class="table table-striped mb-0">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Veículo</th>
                        <th>Motorista</th>
                        <th>Combustível</th>
                        <th>Nº Nota</th>
                        <th>Hodômetro</th>
                        <th class="text-right">Litros</th>
                        <th class="text-right">Valor Total</th>
                    </tr>
                </thead>
                <tbody>
                    {% if dados %}
                    {% set total_litros = namespace(value=0) %}
                    {% set total_valor = namespace(value=0) %}
                    {% for abastecimento in dados %}
                    {% set total_litros.value = total_litros.value + abastecimento.litros %}
                    {% set total_valor.value = total_valor.value + abastecimento.valor_total %}
                    <tr>
                        <td>{{ abastecimento.data.strftime('%d/%m/%Y') }}</td>
                        <td>{{ abastecimento.veiculo.placa if abastecimento.veiculo else 'N/A' }}</td>
                        <td>{{ abastecimento.motorista.nome_completo if abastecimento.motorista else 'N/A' }}</td>
                        <td>{{ abastecimento.veiculo.combustivel if abastecimento.veiculo else 'N/A' }}</td>
                        <td>{{ abastecimento.numero_nota }}</td>
                        <td>{{ abastecimento.hodometro|number(0) }} km</td>
                        <td class="text-right">{{ "%.1f"|format(abastecimento.litros) }} L</td>
                        <td class="text-right">R$ {{ "%.2f"|format(abastecimento.valor_total) }}</td>
                    </tr>
                    {% endfor %}
                    <tr class="total-row">
                        <td colspan="6" class="text-right">Total:</td>
                        <td class="text-right">{{ "%.1f"|format(total_litros.value) }} L</td>
                        <td class="text-right">R$ {{ "%.2f"|format(total_valor.value) }}</td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="8" class="text-center text-muted py-3">
                            Nenhum abastecimento encontrado com os filtros aplicados.
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Rodapé para impressão -->
    <div class="footer">
        <p>Relatório gerado automaticamente pelo Sistema de Gestão de Combustível</p>
        <p>Página <span class="page"></span></p>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
function removeFilter(chave) {
    const url = new URL(window.location.href);
    url.searchParams.delete(chave);
    window.location.href = url.toString();
}
</script>
{% endblock %}